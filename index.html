<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Wakhty - Optimize your daily routine and track your progress">
    <title>Wakktyy - Daily Routine Optimizer</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #f59e0b;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --accent: #10b981;
            --danger: #ef4444;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #e2e8f0;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
        }

        [data-theme="neon"] {
            --primary: #ff0080;
            --secondary: #00ff80;
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a0a1a;
            --bg-card: #2a1a2a;
            --accent: #80ff00;
        }

        [data-theme="pastel"] {
            --primary: #a78bfa;
            --secondary: #fbbf24;
            --bg-primary: #fef3f2;
            --bg-secondary: #fdf4ff;
            --bg-card: #ffffff;
            --text-primary: #4c1d95;
            --text-secondary: #7c3aed;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            margin: 0;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .theme-selector {
            display: flex;
            gap: 10px;
        }

        .theme-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .theme-btn:hover {
            transform: scale(1.1);
        }

        .theme-btn.active {
            border-color: var(--primary);
            border-width: 3px;
        }

        .theme-btn.dark { background: linear-gradient(45deg, #0f172a, #1e293b); }
        .theme-btn.light { background: linear-gradient(45deg, #f8fafc, #e2e8f0); }
        .theme-btn.neon { background: linear-gradient(45deg, #ff0080, #00ff80); }
        .theme-btn.pastel { background: linear-gradient(45deg, #a78bfa, #fbbf24); }

        .nav {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            background: var(--bg-card);
            border: none;
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .welcome-card {
            text-align: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-bottom: 30px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--bg-secondary);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: var(--accent);
            color: white;
        }

        .timeline {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: var(--bg-secondary);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            position: relative;
        }

        .timeline-item.completed {
            border-left-color: var(--accent);
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.2), rgba(255, 255, 255, 0.1));
        }

        .timeline-item.completed .timeline-title {
            text-decoration: line-through;
        }

        .timeline-time {
            font-weight: 700;
            color: var(--primary);
            min-width: 80px;
            margin-right: 20px;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .timeline-emoji {
            font-size: 1.5rem;
            margin-left: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .streak-counter {
            background: linear-gradient(45deg, var(--accent), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 3rem;
            font-weight: 800;
        }

        .reminder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1001;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .task-checkbox {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { flex-direction: column; gap: 20px; }
            .nav { justify-content: center; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .timeline-item { flex-direction: column; text-align: center; }
            .timeline-time { margin-right: 0; margin-bottom: 10px; }
            .task-checkbox { position: static; margin-top: 10px; }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="container">
        <header class="header">
            <h1 class="logo">‚ö° Waktyy</h1>
            <div class="theme-selector" role="radiogroup" aria-label="Theme selection">
                <button class="theme-btn dark active" data-theme="dark" aria-label="Dark theme"></button>
                <button class="theme-btn light" data-theme="light" aria-label="Light theme"></button>
                <button class="theme-btn neon" data-theme="neon" aria-label="Neon theme"></button>
                <button class="theme-btn pastel" data-theme="pastel" aria-label="Pastel theme"></button>
            </div>
        </header>

        <nav class="nav" role="navigation">
            <button class="nav-btn active" data-page="home" aria-label="Home page">üè† Home</button>
            <button class="nav-btn" data-page="scheduler" aria-label="Scheduler page">üìÖ Scheduler</button>
            <button class="nav-btn" data-page="reminders" aria-label="Reminders page">üîî Reminders</button>
            <button class="nav-btn" data-page="progress" aria-label="Progress page">üìä Progress</button>
            <button class="nav-btn" data-page="profile" aria-label="Profile page">üë§ Profile</button>
        </nav>

        <div id="home" class="page active">
            <div class="welcome-card card">
                <div class="avatar" id="userAvatar">üéØ</div>
                <h2 id="welcomeText">Welcome back, Student!</h2>
                <p>Level <span id="userLevel">1</span> ‚Ä¢ <span id="userXP">0</span> XP</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number streak-counter" id="currentStreak">0</span>
                    <div>Day Streak üî•</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="tasksCompleted">0</span>
                    <div>Tasks Done Today ‚úÖ</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="studyTime">0h</span>
                    <div>Study Time Today üìö</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="hobbyTime">0h</span>
                    <div>Hobby Time Today üé≠</div>
                </div>
            </div>

            <div class="card">
                <h3>Today's Schedule</h3>
                <div id="todaysSummary">
                    <div class="timeline-item">
                        <span class="timeline-time">--:--</span>
                        <div class="timeline-content">
                            <div class="timeline-title">No schedule created yet</div>
                            <div>Create your first schedule to get started! üöÄ</div>
                        </div>
                        <span class="timeline-emoji">üìÖ</span>
                    </div>
                </div>
                <button class="btn btn-primary" id="createScheduleBtn" data-page="scheduler">üöÄ Create My Schedule</button>
            </div>
        </div>

        <div id="scheduler" class="page">
            <div class="card">
                <h2>üìÖ Create Your Perfect Day</h2>
                <form id="scheduleForm" novalidate>
                    <div class="input-group">
                        <label for="userName">Your Name</label>
                        <input type="text" id="userName" placeholder="Enter your name" required>
                    </div>
                    <div class="input-group">
                        <label>School Schedule</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="time" id="schoolStart" value="08:00" required>
                            <input type="time" id="schoolEnd" value="15:00" required>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Sleep Schedule</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="time" id="bedTime" value="22:00" required>
                            <input type="time" id="wakeTime" value="07:00" required>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="studyHours">Study Goals (hours per day)</label>
                        <input type="number" id="studyHours" min="1" max="8" value="2" required>
                    </div>
                    <div class="input-group">
                        <label for="subjects">Study Subjects (comma-separated)</label>
                        <input type="text" id="subjects" placeholder="Math, Science, History" required>
                    </div>
                    <div class="input-group">
                        <label>Exercise Time</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="time" id="gymTime" value="16:00">
                            <input type="number" id="gymDuration" min="30" max="180" value="60" placeholder="Minutes">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="hobbies">Hobbies & Personal Goals</label>
                        <textarea id="hobbies" rows="3" placeholder="Reading, music, art..."></textarea>
                    </div>
                    <div class="input-group">
                        <label for="hobbyDuration">Hobby Duration (minutes, min 60)</label>
                        <input type="number" id="hobbyDuration" min="60" max="240" value="60" placeholder="e.g., 60">
                    </div>
                    <button type="submit" class="btn btn-primary">‚ú® Generate My Schedule!</button>
                </form>
            </div>
            <div id="generatedSchedule" class="timeline" style="display: none;">
                <h3>üéØ Your Optimized Schedule</h3>
                <div id="scheduleTimeline"></div>
                <button class="btn btn-success" id="saveScheduleBtn">üíæ Save This Schedule</button>
            </div>
        </div>

        <div id="reminders" class="page">
            <div class="card">
                <h3>Add Custom Reminder or Task</h3>
                <div class="input-group">
                    <label for="customReminderTime">Time</label>
                    <input type="time" id="customReminderTime">
                </div>
                <div class="input-group">
                    <label for="customReminderText">Message/Task</label>
                    <input type="text" id="customReminderText" placeholder="e.g., Study Physics or Hobbies: Painting">
                </div>
                <div class="input-group">
                    <label for="customReminderDuration">Duration (minutes, optional for study/hobby tasks)</label>
                    <input type="number" id="customReminderDuration" min="5" max="240" placeholder="e.g., 30">
                </div>
                <button class="btn btn-primary" id="addReminderBtn">‚ûï Add Reminder/Task</button>
            </div>
            <div class="card">
                <h3>Today's Reminders & Tasks</h3>
                <div id="remindersList">
                    <p style="color: var(--text-secondary); font-style: italic;">Create a schedule or add reminders! üìÖ</p>
                </div>
            </div>
        </div>

        <div id="progress" class="page">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="progressStreak">0</span>
                    <div>Day Streak üî•</div>
                    <div class="progress-bar"><div class="progress-fill" id="streakProgress" style="width: 0%"></div></div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="weeklyCompletion">0%</span>
                    <div>Weekly Completion üìà</div>
                    <div class="progress-bar"><div class="progress-fill" id="weeklyProgress" style="width: 0%"></div></div>
                </div>
            </div>
            <div class="card">
                <h3>‚úÖ Completed Tasks History</h3>
                <div id="completedTasksList">
                    <p style="color: var(--text-secondary); font-style: italic;">No tasks completed yet! üìÖ</p>
                </div>
            </div>
            <div class="card">
                <h3>üèÜ Achievements</h3>
                <div id="achievementsList">
                    <p style="color: var(--text-secondary); font-style: italic;">Complete tasks to unlock achievements! üéØ</p>
                </div>
            </div>
        </div>

        <div id="profile" class="page">
            <div class="card">
                <h2>üë§ Your Profile</h2>
                <div style="text-align: center;">
                    <div class="avatar" style="width: 120px; height: 120px; font-size: 3rem;">
                        <span id="profileAvatar">üéØ</span>
                    </div>
                    <h3 id="profileName">Student</h3>
                    <p>Level <span id="profileLevel">1</span> ‚Ä¢ <span id="profileXP">0</span> XP</p>
                </div>
            </div>
            <div class="card">
                <h3>üé≠ Choose Your Avatar</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;" role="radiogroup" aria-label="Avatar selection">
                    <button class="avatar" style="width: 50px; height: 50px; cursor: pointer;" data-avatar="üéØ" aria-label="Target avatar">üéØ</button>
                    <button class="avatar" style="width: 50px; height: 50px; cursor: pointer;" data-avatar="üöÄ" aria-label="Rocket avatar">üöÄ</button>
                    <button class="avatar" style="width: 50px; height: 50px; cursor: pointer;" data-avatar="‚ö°" aria-label="Lightning avatar">‚ö°</button>
                    <button class="avatar" style="width: 50px; height: 50px; cursor: pointer;" data-avatar="üî•" aria-label="Fire avatar">üî•</button>
                </div>
            </div>
            <div class="card">
                <h3>üìà Personal Goals</h3>
                <div class="input-group">
                    <label for="dailyStudyGoal">Daily Study Goal (hours)</label>
                    <input type="number" id="dailyStudyGoal" min="1" max="12" value="3">
                </div>
                <div class="input-group">
                    <label for="weeklyExerciseGoal">Weekly Exercise Goal (sessions)</label>
                    <input type="number" id="weeklyExerciseGoal" min="1" max="7" value="4">
                </div>
                <div class="input-group">
                    <label for="sleepGoal">Sleep Goal (hours)</label>
                    <input type="number" id="sleepGoal" min="6" max="12" value="8">
                </div>
                <div class="input-group">
                    <label for="dailyHobbyGoal">Daily Hobby Goal (hours)</label>
                    <input type="number" id="dailyHobbyGoal" min="1" max="4" value="1">
                </div>
                <button class="btn btn-primary" id="saveProfileBtn">üíæ Save Goals</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification" role="alert"></div>

    <script>
        // State management
        const appState = {
            user: {
                name: 'Student',
                avatar: 'üéØ',
                level: 1,
                xp: 0,
                streak: 0,
                theme: 'dark',
                schedulesCreated: 0,
                totalTasksCompleted: 0,
                goals: { dailyStudy: 3, weeklyExercise: 4, sleep: 8, dailyHobby: 1 }
            },
            schedule: [],
            completedTasks: [],
            reminders: [],
            stats: {
                tasksCompletedToday: 0,
                studyTime: 0,
                hobbyTime: 0,
                lastReviewDate: null,
                lastStudyHours: 0
            },
            achievements: []
        };

        // DOM elements
        const DOM = {
            get: id => document.getElementById(id),
            query: selector => document.querySelector(selector),
            queryAll: selector => document.querySelectorAll(selector),
            elements: {
                navBtns: 'nav-btn',
                pages: 'page',
                themeBtns: 'theme-btn',
                scheduleForm: 'scheduleForm',
                saveScheduleBtn: 'saveScheduleBtn',
                addReminderBtn: 'addReminderBtn',
                saveProfileBtn: 'saveProfileBtn',
                avatarBtns: '[data-avatar]',
                notification: 'notification',
                createScheduleBtn: 'createScheduleBtn'
            }
        };

        // Utility functions
        const Utils = {
            debounce: (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            },
            isStudyTask: task => task.type === 'study' || /study|studying|styng/i.test(task.title),
            isHobbyTask: task => task.type === 'hobby' || /hobby|hobbies/i.test(task.title),
            timeToMinutes: time => {
                const [hrs, mins] = time.split(':').map(Number);
                return hrs * 60 + mins;
            },
            minutesToTime: totalMins => {
                const hrs = Math.floor(totalMins / 60) % 24;
                const mins = totalMins % 60;
                return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            },
            addMinutes: (time, minutes) => {
                try {
                    const totalMins = Utils.timeToMinutes(time) + minutes;
                    return Utils.minutesToTime(totalMins);
                } catch (error) {
                    console.error('addMinutes error:', error);
                    return time;
                }
            },
            checkOverlap: (schedule, newTask) => {
                const newStart = Utils.timeToMinutes(newTask.time);
                const newEnd = newStart + (newTask.duration || 0);
                return schedule.some(task => {
                    const taskStart = Utils.timeToMinutes(task.time);
                    const taskEnd = taskStart + (task.duration || 0);
                    return (newStart >= taskStart && newStart < taskEnd) || (newEnd > taskStart && newEnd <= taskEnd);
                });
            }
        };

        // Persistence
        const Persistence = {
            save: () => {
                try {
                    const state = {
                        user: appState.user,
                        schedule: appState.schedule,
                        completedTasks: appState.completedTasks.slice(-50),
                        reminders: appState.reminders.slice(-20),
                        stats: appState.stats,
                        achievements: appState.achievements.slice(-10)
                    };
                    localStorage.setItem('wakhtyState', JSON.stringify(state));
                } catch (error) {
                    console.error('Save error:', error);
                    UI.notify('‚ö†Ô∏è Failed to save data.');
                }
            },
            load: () => {
                try {
                    const savedState = localStorage.getItem('wakhtyState');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        Object.assign(appState, state);
                        appState.user.goals = state.user.goals || { dailyStudy: 3, weeklyExercise: 4, sleep: 8, dailyHobby: 1 };
                        appState.stats = {
                            tasksCompletedToday: state.stats.tasksCompletedToday || 0,
                            studyTime: state.stats.studyTime || 0,
                            hobbyTime: state.stats.hobbyTime || 0,
                            lastReviewDate: state.stats.lastReviewDate || null,
                            lastStudyHours: state.stats.lastStudyHours || 0
                        };
                    }
                } catch (error) {
                    console.error('Load error:', error);
                    UI.notify('‚ö†Ô∏è Failed to load data. Using defaults.');
                }
            }
        };

        const debouncedSave = Utils.debounce(Persistence.save, 500);

        // State management
        const State = {
            resetDaily: () => {
                const today = new Date().toDateString();
                if (appState.stats.lastReviewDate !== today) {
                    appState.stats.tasksCompletedToday = 0;
                    appState.stats.studyTime = 0;
                    appState.stats.hobbyTime = 0;
                    appState.stats.lastReviewDate = today;
                    Persistence.save();
                }
            },
            updateStreak: () => {
                const today = new Date().toDateString();
                if (appState.stats.lastReviewDate !== today && appState.stats.tasksCompletedToday > 0) {
                    appState.user.streak++;
                    appState.stats.lastReviewDate = today;
                    UI.notify(`üî• Streak increased to ${appState.user.streak}!`);
                    Persistence.save();
                }
            },
            updateLevel: () => {
                const newLevel = Math.floor(appState.user.xp / 100) + 1;
                if (newLevel > appState.user.level) {
                    appState.user.level = newLevel;
                    UI.notify(`üéâ Level up! Now level ${newLevel}!`);
                    Persistence.save();
                }
            },
            resetSchedule: () => {
                // console.log('Resetting schedule and reminders');
                appState.schedule = [];
                appState.reminders = [];
                appState.stats.tasksCompletedToday = 0;
                appState.stats.studyTime = 0;
                appState.stats.hobbyTime = 0;
                appState.stats.lastReviewDate = new Date().toDateString();
                UI.notify('üéâ All tasks completed! Ready to create a new schedule! üöÄ');
                UI.update();
                Persistence.save();
            },
            completeTask: (task, index, source = 'schedule') => {
                // console.log(`Completing task: ${task.title}, source: ${source}, index: ${index}`);
                const wasCompleted = task.completed;
                task.completed = true;
                const isStudy = Utils.isStudyTask(task);
                const isHobby = Utils.isHobbyTask(task);
                const duration = task.duration || (isStudy ? 30 : isHobby ? 60 : 0);

                if (!wasCompleted) {
                    appState.stats.tasksCompletedToday++;
                    appState.user.totalTasksCompleted++;
                    appState.user.xp += 10;
                    if (isStudy) appState.stats.studyTime += duration / 60;
                    if (isHobby) appState.stats.hobbyTime += duration / 60;
                    task.duration = duration;

                    appState.completedTasks.push({
                        ...task,
                        completedAt: new Date().toISOString()
                    });

                    State.updateStreak();
                    State.updateLevel();
                    UI.notify(`‚úÖ ${task.title} completed! +10 XP`);
                }

                if (source === 'schedule') {
                    appState.schedule[index] = task;
                    // Check if all schedule tasks are completed
                    if (appState.schedule.length > 0 && appState.schedule.every(t => t.completed)) {
                        // console.log('All schedule tasks completed, triggering reset');
                        State.resetSchedule();
                    }
                } else {
                    appState.reminders[index] = task;
                }

                UI.update();
                Achievements.update();
                Persistence.save();
                // console.log('State after completion:', JSON.parse(JSON.stringify(appState)));
            },
            uncompleteTask: (task, index, source = 'schedule') => {
                // console.log(`Uncompleting task: ${task.title}, source: ${source}, index: ${index}`);
                const wasCompleted = task.completed;
                task.completed = false;
                const isStudy = Utils.isStudyTask(task);
                const isHobby = Utils.isHobbyTask(task);
                const duration = task.duration || (isStudy ? 30 : isHobby ? 60 : 0);

                if (wasCompleted) {
                    appState.stats.tasksCompletedToday = Math.max(0, appState.stats.tasksCompletedToday - 1);
                    appState.user.totalTasksCompleted = Math.max(0, appState.user.totalTasksCompleted - 1);
                    appState.user.xp = Math.max(0, appState.user.xp - 10);
                    if (isStudy) appState.stats.studyTime = Math.max(0, appState.stats.studyTime - duration / 60);
                    if (isHobby) appState.stats.hobbyTime = Math.max(0, appState.stats.hobbyTime - duration / 60);

                    appState.completedTasks = appState.completedTasks.filter(
                        t => t.time !== task.time || t.title !== task.title
                    );

                    UI.notify(`‚Ü©Ô∏è ${task.title} unmarked`);
                }

                if (source === 'schedule') appState.schedule[index] = task;
                else appState.reminders[index] = task;

                UI.update();
                Achievements.update();
                Persistence.save();
            }
        };

        // UI management
        const UI = {
            notify: message => {
                const notification = DOM.get('notification');
                notification.textContent = message;
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3000);
            },
            showPage: pageId => {
                DOM.queryAll(`.${DOM.elements.navBtns}`).forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.page === pageId);
                    btn.setAttribute('aria-current', btn.dataset.page === pageId ? 'page' : 'false');
                });
                DOM.queryAll(`.${DOM.elements.pages}`).forEach(page => page.classList.toggle('active', page.id === pageId));
                debouncedSave();
            },
            setTheme: theme => {
                document.body.setAttribute('data-theme', theme);
                appState.user.theme = theme;
                DOM.queryAll(`.${DOM.elements.themeBtns}`).forEach(btn => btn.classList.toggle('active', btn.dataset.theme === theme));
                UI.notify(`üé® Theme set to ${theme}!`);
                Persistence.save();
            },
            displaySchedule: () => {
                const timeline = DOM.get('scheduleTimeline');
                const generatedSchedule = DOM.get('generatedSchedule');
                timeline.innerHTML = '';

                appState.schedule.forEach((item, index) => {
                    const isStudy = Utils.isStudyTask(item);
                    const isHobby = Utils.isHobbyTask(item);
                    const div = document.createElement('div');
                    div.className = `timeline-item ${item.completed ? 'completed' : ''}`;
                    div.innerHTML = `
                        <span class="timeline-time">${item.time}</span>
                        <div class="timeline-content">
                            <div class="timeline-title">${item.title}</div>
                            <div>${item.description}${(isStudy || isHobby) && item.duration ? ` (${item.duration} min)` : ''}</div>
                        </div>
                        <span class="timeline-emoji">${item.emoji || 'üìÖ'}</span>
                        <input type="checkbox" class="task-checkbox" data-index="${index}" ${item.completed ? 'checked' : ''} aria-label="Mark ${item.title} as completed">
                    `;
                    timeline.appendChild(div);
                });

                timeline.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', e => {
                        const index = parseInt(e.target.dataset.index);
                        if (e.target.checked) {
                            State.completeTask({ ...appState.schedule[index] }, index, 'schedule');
                        } else {
                            State.uncompleteTask({ ...appState.schedule[index] }, index, 'schedule');
                        }
                    });
                });

                generatedSchedule.style.display = appState.schedule.length ? 'block' : 'none';
            },
            displayReminders: () => {
                const remindersList = DOM.get('remindersList');
                remindersList.innerHTML = appState.reminders.length ? '' : '<p style="color: var(--text-secondary); font-style: italic;">Create a schedule or add reminders! üìÖ</p>';

                appState.reminders.forEach((reminder, index) => {
                    const isStudy = Utils.isStudyTask(reminder);
                    const isHobby = Utils.isHobbyTask(reminder);
                    const div = document.createElement('div');
                    div.className = `reminder-item ${reminder.completed ? 'completed' : ''}`;
                    div.innerHTML = `
                        <div>
                            <div class="reminder-time">${reminder.time}</div>
                            <div>${reminder.message}${(isStudy || isHobby) && reminder.duration ? ` (${reminder.duration} min)` : ''}</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="checkbox" class="reminder-checkbox" data-index="${index}" ${reminder.completed ? 'checked' : ''} aria-label="Mark ${reminder.message} as completed">
                            <button class="btn btn-primary" data-index="${index}" aria-label="Remove reminder for ${reminder.message}">‚ùå</button>
                        </div>
                    `;
                    remindersList.appendChild(div);
                });

                remindersList.querySelectorAll('.reminder-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', e => {
                        const index = parseInt(e.target.dataset.index);
                        if (e.target.checked) {
                            State.completeTask({ ...appState.reminders[index] }, index, 'reminders');
                        } else {
                            State.uncompleteTask({ ...appState.reminders[index] }, index, 'reminders');
                        }
                    });
                });

                remindersList.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.dataset.index);
                        if (appState.reminders[index].completed) {
                            State.uncompleteTask({ ...appState.reminders[index] }, index, 'reminders');
                        }
                        appState.reminders.splice(index, 1);
                        UI.displayReminders();
                        UI.update();
                        Persistence.save();
                        UI.notify('üóëÔ∏è Reminder/task removed!');
                    });
                });
            },
            displayCompletedTasks: () => {
                const completedTasksList = DOM.get('completedTasksList');
                completedTasksList.innerHTML = appState.completedTasks.length ? '' : '<p style="color: var(--text-secondary); font-style: italic;">No tasks completed yet! üìÖ</p>';

                appState.completedTasks.forEach(task => {
                    const isStudy = Utils.isStudyTask(task);
                    const isHobby = Utils.isHobbyTask(task);
                    const div = document.createElement('div');
                    div.className = 'timeline-item completed';
                    div.innerHTML = `
                        <span class="timeline-time">${task.time}</span>
                        <div class="timeline-content">
                            <div class="timeline-title">${task.title}</div>
                            <div>${task.description}${(isStudy || isHobby) && task.duration ? ` (${task.duration} min)` : ''} (Completed: ${new Date(task.completedAt).toLocaleDateString()})</div>
                        </div>
                        <span class="timeline-emoji">${task.emoji || '‚úÖ'}</span>
                    `;
                    completedTasksList.appendChild(div);
                });
            },
            updateTodaysSummary: () => {
                const summary = DOM.get('todaysSummary');
                if (!appState.schedule.length) {
                    summary.innerHTML = `
                        <div class="timeline-item">
                            <span class="timeline-time">--:--</span>
                            <div class="timeline-content">
                                <div class="timeline-title">No schedule created yet</div>
                                <div>Create your first schedule to get started! üöÄ</div>
                            </div>
                            <span class="timeline-emoji">üìÖ</span>
                        </div>`;
                    return;
                }

                summary.innerHTML = '';
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                const upcoming = appState.schedule.filter(item => item.time >= currentTime && !item.completed).slice(0, 3);

                if (!upcoming.length) {
                    summary.innerHTML = `
                        <div class="timeline-item">
                            <span class="timeline-time">üéâ</span>
                            <div class="timeline-content">
                                <div class="timeline-title">All done for today!</div>
                                <div>Great job! Create a new schedule to keep going! üöÄ</div>
                            </div>
                            <span class="timeline-emoji">‚úÖ</span>
                        </div>`;
                    return;
                }

                upcoming.forEach(item => {
                    const isStudy = Utils.isStudyTask(item);
                    const isHobby = Utils.isHobbyTask(item);
                    const div = document.createElement('div');
                    div.className = 'timeline-item';
                    div.innerHTML = `
                        <span class="timeline-time">${item.time}</span>
                        <div class="timeline-content">
                            <div class="timeline-title">${item.title}</div>
                            <div>${item.description}${(isStudy || isHobby) && item.duration ? ` (${item.duration} min)` : ''}</div>
                        </div>
                        <span class="timeline-emoji">${item.emoji || 'üìÖ'}</span>
                    `;
                    summary.appendChild(div);
                });
            },
            update: () => {
                DOM.get('welcomeText').textContent = `Welcome back, ${appState.user.name}!`;
                DOM.get('userLevel').textContent = appState.user.level;
                DOM.get('userXP').textContent = appState.user.xp;
                DOM.get('userAvatar').textContent = appState.user.avatar;
                DOM.get('profileName').textContent = appState.user.name;
                DOM.get('profileLevel').textContent = appState.user.level;
                DOM.get('profileXP').textContent = appState.user.xp;
                DOM.get('profileAvatar').textContent = appState.user.avatar;
                DOM.get('currentStreak').textContent = appState.user.streak;
                DOM.get('tasksCompleted').textContent = appState.stats.tasksCompletedToday;
                DOM.get('studyTime').textContent = `${appState.stats.studyTime.toFixed(1)}h`;
                DOM.get('hobbyTime').textContent = `${appState.stats.hobbyTime.toFixed(1)}h`;
                DOM.get('progressStreak').textContent = appState.user.streak;
                DOM.get('weeklyCompletion').textContent = `${Math.min(100, appState.user.streak * 14.3).toFixed(0)}%`;
                DOM.get('streakProgress').style.width = `${Math.min(100, (appState.user.streak / 30) * 100)}%`;
                DOM.get('weeklyProgress').style.width = `${Math.min(100, appState.user.streak * 14.3)}%`;
                DOM.get('dailyStudyGoal').value = appState.user.goals.dailyStudy;
                DOM.get('weeklyExerciseGoal').value = appState.user.goals.weeklyExercise;
                DOM.get('sleepGoal').value = appState.user.goals.sleep;
                DOM.get('dailyHobbyGoal').value = appState.user.goals.dailyHobby;
                document.body.setAttribute('data-theme', appState.user.theme);
                DOM.queryAll(`.${DOM.elements.themeBtns}`).forEach(btn => btn.classList.toggle('active', btn.dataset.theme === appState.user.theme));

                UI.updateTodaysSummary();
                UI.displaySchedule();
                UI.displayReminders();
                Achievements.display();
                UI.displayCompletedTasks();
            }
        };

        // Schedule management
        const Schedule = {
            generate: e => {
                e.preventDefault();
                const formData = {
                    userName: DOM.get('userName').value.trim(),
                    schoolStart: DOM.get('schoolStart').value,
                    schoolEnd: DOM.get('schoolEnd').value,
                    bedTime: DOM.get('bedTime').value,
                    wakeTime: DOM.get('wakeTime').value,
                    studyHours: parseInt(DOM.get('studyHours').value),
                    subjects: DOM.get('subjects').value.split(',').map(s => s.trim()).filter(s => s),
                    gymTime: DOM.get('gymTime').value,
                    gymDuration: parseInt(DOM.get('gymDuration').value) || 60,
                    hobbies: DOM.get('hobbies').value.trim(),
                    hobbyDuration: parseInt(DOM.get('hobbyDuration').value) || 60
                };

                if (!formData.userName) return UI.notify('‚ö†Ô∏è Please enter your name.');
                if (!formData.subjects.length) return UI.notify('‚ö†Ô∏è Please enter at least one subject.');
                if (formData.studyHours < 1 || formData.studyHours > 8) return UI.notify('‚ö†Ô∏è Study hours must be 1-8.');
                if (formData.gymDuration < 30 || formData.gymDuration > 180) return UI.notify('‚ö†Ô∏è Exercise duration must be 30-180 minutes.');
                if (formData.hobbyDuration < 60 || formData.hobbyDuration > 240) return UI.notify('‚ö†Ô∏è Hobby duration must be 60-240 minutes.');
                if (formData.schoolStart >= formData.schoolEnd) return UI.notify('‚ö†Ô∏è School end must be after start.');
                if (Utils.timeToMinutes(formData.bedTime) <= Utils.timeToMinutes(formData.wakeTime) + 360) {
                    return UI.notify('‚ö†Ô∏è Bedtime must be at least 6 hours after wake time.');
                }

                const availableTime = Utils.timeToMinutes(formData.bedTime) - Utils.timeToMinutes(formData.schoolEnd) - 90;
                const requiredTime = formData.studyHours * 60 + formData.gymDuration + formData.hobbyDuration + 60;
                if (availableTime < requiredTime) {
                    return UI.notify('‚ö†Ô∏è Not enough time for all tasks before bedtime.');
                }

                appState.user.name = formData.userName;
                appState.stats.lastStudyHours = formData.studyHours;
                appState.schedule = Schedule.create(formData);
                UI.update();
                Persistence.save();
                UI.notify('üéØ Schedule generated!');
            },
            create: data => {
                const schedule = [];
                const addTimeSlot = (time, title, description, emoji, type = 'general', duration = 0) => {
                    const task = { time, title, description, completed: false, emoji, type, duration };
                    if (!Utils.checkOverlap(schedule, task)) {
                        schedule.push(task);
                    }
                };

                addTimeSlot(data.wakeTime, 'Wake Up', 'Morning routine', '‚òÄÔ∏è');
                addTimeSlot(Utils.addMinutes(data.wakeTime, 30), 'Breakfast', 'Fuel up!', 'üç≥');
                addTimeSlot(data.schoolStart, 'School', 'Learn and focus!', 'üè´');
                addTimeSlot(data.schoolEnd, 'School Ends', 'Great job!', '‚úÖ');
                addTimeSlot(Utils.addMinutes(data.schoolEnd, 15), 'Lunch', 'Recharge', 'üç¥');
                if (data.gymTime) addTimeSlot(data.gymTime, 'Exercise', 'Stay active!', 'üèÉ‚Äç‚ôÄÔ∏è', 'exercise', data.gymDuration);

                let currentTime = Utils.addMinutes(data.gymTime || data.schoolEnd, data.gymTime ? data.gymDuration : 30);
                const sessionDuration = Math.max(30, (data.studyHours * 60) / data.subjects.length);
                data.subjects.forEach((subject, i) => {
                    addTimeSlot(currentTime, `Study: ${subject}`, `Focus on ${subject}`, 'üìñ', 'study', sessionDuration);
                    currentTime = Utils.addMinutes(currentTime, sessionDuration);
                    if (i < data.subjects.length - 1) {
                        addTimeSlot(currentTime, 'Break', 'Short rest', '‚òï', 'break', 15);
                        currentTime = Utils.addMinutes(currentTime, 15);
                    }
                });

                currentTime = Utils.addMinutes(currentTime, 30);
                addTimeSlot(currentTime, 'Dinner', 'Enjoy your meal!', 'üçΩÔ∏è');

                if (data.hobbies) {
                    const hobbyTime = Utils.addMinutes(data.bedTime, -90);
                    addTimeSlot(hobbyTime, 'Hobbies', data.hobbies, 'üé≠', 'hobby', Math.max(60, data.hobbyDuration));
                }

                addTimeSlot(Utils.addMinutes(data.bedTime, -30), 'Wind Down', 'Relax', 'üåô');
                addTimeSlot(data.bedTime, 'Bedtime', 'Sleep well!', 'üõå');

                return schedule.sort((a, b) => a.time.localeCompare(b.time));
            },
            save: () => {
                appState.user.schedulesCreated++;
                appState.reminders = appState.schedule.map(item => ({
                    time: item.time,
                    message: item.title,
                    type: item.type,
                    duration: item.duration || 0,
                    completed: false
                }));
                UI.update();
                Achievements.update();
                Persistence.save();
                UI.notify('üíæ Schedule saved!');
                UI.showPage('home');
            }
        };

        // Reminders
        const Reminders = {
            add: () => {
                const time = DOM.get('customReminderTime').value;
                const message = DOM.get('customReminderText').value.trim();
                const duration = parseInt(DOM.get('customReminderDuration').value) || 0;

                if (!time || !message) return UI.notify('‚ö†Ô∏è Please enter time and message.');

                const isStudy = Utils.isStudyTask({ title: message });
                const isHobby = Utils.isHobbyTask({ title: message });
                if (isStudy && duration && (duration < 5 || duration > 240)) {
                    return UI.notify('‚ö†Ô∏è Study task duration must be 5-240 minutes.');
                }
                if (isHobby && duration && (duration < 60 || duration > 240)) {
                    return UI.notify('‚ö†Ô∏è Hobby task duration must be 60-240 minutes.');
                }

                const reminder = {
                    time,
                    message,
                    type: isStudy ? 'study' : isHobby ? 'hobby' : 'custom',
                    duration: isStudy ? (duration || 30) : isHobby ? (duration || 60) : duration,
                    completed: false
                };

                if (!Utils.checkOverlap(appState.reminders, reminder)) {
                    appState.reminders.push(reminder);
                    appState.reminders.sort((a, b) => a.time.localeCompare(b.time));
                    UI.displayReminders();
                    Persistence.save();
                    DOM.get('customReminderTime').value = '';
                    DOM.get('customReminderText').value = '';
                    DOM.get('customReminderDuration').value = '';
                    UI.notify('‚úÖ Reminder/task added!');
                } else {
                    UI.notify('‚ö†Ô∏è Task overlaps with another reminder.');
                }
            },
            check: () => {
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                const reminder = appState.reminders.find(r => r.time === currentTime && !r.completed);
                if (reminder) UI.notify(`üîî ${reminder.message}`);
            }
        };

        // Profile
        const Profile = {
            changeAvatar: emoji => {
                appState.user.avatar = emoji;
                UI.update();
                Persistence.save();
                UI.notify(`üé≠ Avatar changed to ${emoji}!`);
            },
            save: () => {
                const goals = {
                    dailyStudy: parseInt(DOM.get('dailyStudyGoal').value) || 3,
                    weeklyExercise: parseInt(DOM.get('weeklyExerciseGoal').value) || 4,
                    sleep: parseInt(DOM.get('sleepGoal').value) || 8,
                    dailyHobby: parseInt(DOM.get('dailyHobbyGoal').value) || 1
                };
                if (goals.dailyStudy < 1 || goals.dailyStudy > 12 ||
                    goals.weeklyExercise < 1 || goals.weeklyExercise > 7 ||
                    goals.sleep < 6 || goals.sleep > 12 ||
                    goals.dailyHobby < 1 || goals.dailyHobby > 4) {
                    return UI.notify('‚ö†Ô∏è Invalid goal values.');
                }
                appState.user.goals = goals;
                UI.update();
                Persistence.save();
                UI.notify('üíæ Goals saved!');
            }
        };

        // Achievements
        const Achievements = {
            update: () => {
                const achievements = [];
                if (appState.user.schedulesCreated >= 1) achievements.push({ title: 'First Schedule', description: 'Created your first schedule!', emoji: 'üìÖ' });
                if (appState.user.streak >= 3) achievements.push({ title: 'Streak Master', description: '3-day streak!', emoji: 'üî•' });
                if (appState.user.totalTasksCompleted >= 10) achievements.push({ title: 'Task Crusher', description: 'Completed 10 tasks!', emoji: 'üí™' });
                if (appState.user.level >= 2) achievements.push({ title: 'Rising Star', description: 'Reached level 2!', emoji: '‚≠ê' });
                if (appState.stats.studyTime >= appState.user.goals.dailyStudy) achievements.push({ title: 'Study Star', description: 'Met your daily study goal!', emoji: 'üìö' });
                if (appState.stats.hobbyTime >= appState.user.goals.dailyHobby) achievements.push({ title: 'Hobby Hero', description: 'Met your daily hobby goal!', emoji: 'üé≠' });
                appState.achievements = achievements;
                Achievements.display();
                Persistence.save();
            },
            display: () => {
                const achievementsList = DOM.get('achievementsList');
                achievementsList.innerHTML = appState.achievements.length ? '' : '<p style="color: var(--text-secondary); font-style: italic;">Complete tasks to unlock achievements! üéØ</p>';

                appState.achievements.forEach(achievement => {
                    const div = document.createElement('div');
                    div.style = 'padding: 10px; margin: 5px 0; background: var(--primary); border-radius: 8px;';
                    div.innerHTML = `<span style="font-size: 1.5rem; margin-right: 10px;">${achievement.emoji}</span> <strong>${achievement.title}</strong>: ${achievement.description}`;
                    achievementsList.appendChild(div);
                });
            }
        };

        // Event listeners
        const Events = {
            setup: () => {
                DOM.queryAll(`.${DOM.elements.navBtns}`).forEach(btn => btn.addEventListener('click', () => UI.showPage(btn.dataset.page)));
                DOM.queryAll(`.${DOM.elements.themeBtns}`).forEach(btn => btn.addEventListener('click', () => UI.setTheme(btn.dataset.theme)));
                DOM.get(DOM.elements.scheduleForm).addEventListener('submit', Schedule.generate);
                DOM.get(DOM.elements.saveScheduleBtn).addEventListener('click', Schedule.save);
                DOM.get(DOM.elements.addReminderBtn).addEventListener('click', Reminders.add);
                DOM.get(DOM.elements.saveProfileBtn).addEventListener('click', Profile.save);
                DOM.queryAll(DOM.elements.avatarBtns).forEach(btn => btn.addEventListener('click', () => Profile.changeAvatar(btn.dataset.avatar)));
                DOM.get(DOM.elements.createScheduleBtn).addEventListener('click', () => UI.showPage('scheduler'));
            }
        };

        // Initialize app
        const init = () => {
            Persistence.load();
            Events.setup();
            State.resetDaily();
            UI.update();
            setInterval(Reminders.check, 60000);
            UI.notify('üëã Welcome to waktyy!');
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
